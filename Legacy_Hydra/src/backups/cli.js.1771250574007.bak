// TEST_EVOLUTION 1771250574003
const readline = require('readline');
const SentraCore = require('./core');
// Import UI tools (CommonJS versions)
const chalk = require('chalk');
const ora = require('ora');
const boxen = require('boxen');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

async function main() {
    console.clear();
    console.log(boxen(chalk.cyan.bold(' S E N T R A   A I ') + '\n' + chalk.dim(' Autonomous Agent v1.0'), {
        padding: 1,
        margin: 1,
        borderStyle: 'round',
        borderColor: 'cyan',
        float: 'center'
    }));

    // Initialize Spinner
    const spinner = ora({
        text: 'Initializing Core Systems...',
        color: 'cyan'
    }).start();

    // Monkey-patch console.log to play nice with spinner
    // This allows "verbose" internal logs to print without breaking the spinner layout
    const originalLog = console.log;
    console.log = (...args) => {
        spinner.stop(); // Stop spinner to print
        originalLog(...args); // Print log
        spinner.start(); // Restart spinner
    };

    // Also patch error/warn
    const originalError = console.error;
    console.error = (...args) => {
        spinner.stop();
        originalError(...args);
        spinner.start();
    };

    const core = new SentraCore();
    await core.start();

    spinner.succeed(chalk.green('System Online.'));
    console.log = originalLog; // Restore for now, or keep it if we want persistent status

    console.log(chalk.dim('────────────────────────────────────────────────'));
    console.log(chalk.bold('Tools Loaded: '));
    const tools = Array.from(core.agent.components.tools.registry.keys());
    console.log(chalk.cyan(tools.join(chalk.dim(' | '))));
    console.log(chalk.dim('────────────────────────────────────────────────\n'));

    const ask = () => {
        if (spinner.isSpinning) spinner.stop();

        rl.on('line', async (line) => {
            const task = line.trim();
            if (!task) {
                process.stdout.write('> ');
                return;
            }

            if (core.agent.state !== 'IDLE') {
                console.log(chalk.yellow('⚠️ Agent is busy. Please wait...'));
                return;
            }

            if (task.toLowerCase() === '/exit') {
                spinner.start('Shutting down...');
                await core.stop();
                spinner.succeed('Goodbye.');
                rl.close();
                process.exit(0);
            }

            console.log(); // spacer

            // Re-enable spinner logging for the task duration
            const taskSpinner = ora({
                text: chalk.blue('Processing...'),
                color: 'cyan'
            }).start();

            console.log = (...args) => {
                taskSpinner.stop();
                originalLog(...args);
                taskSpinner.start();
            };

            try {
                // Formatting the task input
                taskSpinner.stop();
                console.log(boxen(chalk.italic(task), {
                    padding: { top: 0, bottom: 0, left: 1, right: 1 },
                    borderStyle: 'classic',
                    borderColor: 'gray',
                    dimBorder: true
                }));
                taskSpinner.start();

                const result = await core.agent.startTask(task);

                // Stop intercepting logs before printing result (or else spinner restarts)
                console.log = originalLog;

                taskSpinner.succeed(chalk.green('Task Completed.'));

                console.log();
                console.log(boxen(chalk.green.bold('RESULT:\n') + result, {
                    padding: 1,
                    borderColor: 'green',
                    borderStyle: 'round'
                }));

            } catch (error) {
                taskSpinner.fail(chalk.red('Task Failed'));
                console.error(chalk.red(error.message));
            } finally {
                // Restore log
                console.log = originalLog;
                process.stdout.write('> ');
            }
        });
    };

    ask();
}

if (require.main === module) {
    main().catch(console.error);
}
module.exports = main;
